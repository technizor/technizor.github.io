<!DOCTYPE html>
<html>
<body>
<h1>IV Probability Calculator</h1></br>
<h2>Wild Encounter</h2>
<form id="ivForm" action="" method="">
HP: <input type="text" size="2" name="hpIv" value="31">
Atk: <input type="text" size="2" name="atkIv" value="31">
Def: <input type="text" size="2" name="defIv" value="31">
SpA: <input type="text" size="2" name="spAIv" value="31">
SpD: <input type="text" size="2" name="spDIv" value="31">
Spe: <input type="text" size="2" name="speIv" value="31"></br>
Max: <input type="text" size="2" name="lockIv" value="0">
<button type="button" id="genButton" onclick="generateIvs()">Calculate</button></br>
</form>
<p id="output"></p>
<script id="generateWorker" type="javascript/worker">
const MAX = 31;
const LOCK = 32;
const EVEN = 32;
const ODD = 33;
const ANY = 34;

onmessage = function(event) {
    generate(event.data.lock, event.data.spread);
};
function generate(lock, spread) {
	'use strict';
	var iv = [0,0,0,0,0,0];
    var event = {nd : generate1(lock, spread, iv, 0, 0)};
	postMessage(event);
}

function generate1(nm, ds, iv, mc, n) {
	'use strict';
	var nd = [0,0];
	for (var stat = 0; stat <= LOCK; stat++) {
		iv[n] = stat;
		if (iv[n] == LOCK)
        {
			mc++;
        }
		if (mc + 5 - n >= nm)
        {
			if (n < 5)
            {
				var cp = generate1(nm, ds, iv, mc, n + 1);
				nd[0] += cp[0];
				nd[1] += cp[1];
			} else if (mc == nm)
            {
				var p = true;
				for (var s = 0; p && s < 6; s++)
                {
					var bs = iv[s];
					if(bs == LOCK)
					{
                        bs = MAX;
					}
                    if ((ds[s] <= MAX && ds[s] != bs) || (ds[s] == EVEN && bs % 2 !== 0) || (ds[s] == ODD && bs % 2 !== 1))
                    {
						p = false;
                    }
				}
				if (p)
                {
					nd[0]++;
                }
				nd[1]++;
			}
		}
		if (iv[n] == LOCK)
        {
			mc--;
        }
	}
	return nd;
}
</script>
<script id="breedWorker" type="javascript/worker">
const MAX = 31;
const EVEN = 32;
const ODD = 33;
const ANY = 34;
const FATHER = 32;
const MOTHER = 33;

onmessage = function(event) {
    breed(event.data.lock, event.data.spread, event.data.father, event.data.mother);
};
function breed(locked, spread, father, mother) {
	'use strict';
	var iv = [0,0,0,0,0,0];
    var event = {nd : breed1(lock, spread, father, mother, iv, 0, 0)};
	postMessage(event);
	return nd;
}

function breed1(nm, ds, fs, ms, iv, mc, n) {
    'use strict';
    var nd = [0,0];
	for (var stat = 0; stat <= MOTHER; stat++) {
		iv[n] = stat;
		if (iv[n] == MOTHER || iv[n] == FATHER)
        {
			mc++;
        }
		if (mc + 5 - n >= nm)
        {
            if (n < 5)
            {
				var cp = breed(nm, ds, fs, ms, iv, mc, n + 1);
				nd[0] += cp[0];
				nd[1] += cp[1];
			} else if (mc == nm)
            {
				var p = true;
				for (var s = 0; p && s < 6; s++)
                {
					var bs = iv[s];
					if(bs == FATHER)
					{
                        bs = fs[s];
					} else if (bs == MOTHER)
                    {
						bs = ms[s];
					}
                    if ((ds[s] <= MAX && ds[s] != bs) || (ds[s] == EVEN && bs % 2 !== 0) || (ds[s] == ODD && bs % 2 !== 1))
                    {
						p = false;
                    }
				}
				if (p)
                {
					nd[0]++;
                }
				nd[1]++;
			}
		}
		if (iv[n] == MOTHER || iv[n] == FATHER)
        {
			mc--;
        }
	}
	return nd;
}
</script>
<script>
const MAX = 31;
const EVEN = 32;
const ODD = 33;
const ANY = 34;

function generateIvs() {
    'use strict';
    document.getElementById('output').innerHTML = '';
    document.getElementById('genButton').innerHTML = 'Calculating';
    document.getElementById('genButton').disabled = true;
    var spread = [ 0, 0, 0, 0, 0, 0 ];
    var inputs = document.getElementsByTagName('input');
    for(var i = 0; i < 6; i++)
    {
        spread[i] = parseInt(inputs[i].value,10);
        if(isNaN(spread[i]))
        {
            if(spread[i] == 'x' || spread[i] == 'X')
            {
                spread[i] = ANY;
            } else if(spread[i] == 'e' || spread[i] == 'E')
            {
                spread[i] = EVEN;
            } else if(spread[i] == 'o' || spread[i] == 'O')
            {
                spread[i] = ODD;
            } else
            {
                spread[i] = ANY;
                inputs[i].value = 'x';
            }
        } else if (spread[i] < 0)
        {
            spread[i] = 0;
            inputs[i].value = 0;
        } else if (spread[i] > MAX)
        {
            spread[i] = MAX;
            inputs[i].value = MAX;
        }
    }
    var lock = parseInt(inputs[6].value,10);
    if(isNaN(lock))
    {
        lock = 0;
        inputs[6].value = '0';
    } else if(lock < 0)
    {
        lock = 0;
        inputs[6].value = '0';
    } else if(lock > 6)
    {
        lock = 6;
        inputs[6].value = '6';
    }

    var blob = new Blob([
          document.querySelector('#generateWorker').textContent
        ], { type: "text/javascript" });
    
    if(typeof(Worker) !== 'undefined')
    {
        var worker = new Worker(window.URL.createObjectURL(blob));
        worker.onmessage = function (event) {
            var nd = event.data.nd;
            genUpdate(nd);
            worker.terminate();
        };
        var event = {lock : lock, spread: spread};
        worker.postMessage(event);
    } else
    {
        var aScript = document.createElement('script');
        aScript.setAttribute("id","aScr");
        aScript.setAttribute("type","text/javascript");
        aScript.setAttribute("src", windowURL.createObjectURL(blob));
        var nd = generate(lock, spread);
        genUpdate(nd);
    }
}
function genUpdate(nd)
{
    var p = Math.round(1000000.0 * nd[0] / nd[1])/10000;
    var g = gcd(nd[0],nd[1]);
    if(g > 1)
    {
        var rnd = [nd[0]/g,nd[1]/g];
        document.getElementById("output").innerHTML = "Chance: " + nd[0] + "/" + nd[1] + " = " + rnd[0] + "/" + rnd[1] + ", approx. " + p +"%";
    } else
    {
        document.getElementById("output").innerHTML = "Chance: " + nd[0] + "/" + nd[1] + ", approx. " + p +"%";
    }
    document.getElementById('genButton').innerHTML = 'Calculate';
    document.getElementById('genButton').disabled = false;
    document.removeElementById("aScr");
}
function gcd(a,b)
{
    if(a == 0)
    {
        return b;
    }
    if(b == 0)
    {
        return a;
    }
    return gcd(b, a%b);
}
</script>

</body>
</html>