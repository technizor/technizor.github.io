<!DOCTYPE html>
<html>
<body>
<form id="ivForm" action="" method="">
HP: <input type="text" size="2" name="hpIv" value="31">
Atk: <input type="text" size="2" name="atkIv" value="31">
Def: <input type="text" size="2" name="defIv" value="31">
SpA: <input type="text" size="2" name="spAIv" value="31">
SpD: <input type="text" size="2" name="spDIv" value="31">
Spe: <input type="text" size="2" name="speIv" value="31"></br>
Max: <input type="text" size="2" name="lockIv" value="0">
<button type="button" id="calcButton" onclick="calcIvs()">Calculate</button></br>
</form>
<p id="output"></p>
<script id="worker" type="javascript/worker">

const MAX = 31;
const EVEN = 32;
const ODD = 33;
const ANY = 34;

onmessage = function(message) {
    generate(message.data.lock, message.data.spread);
};
function generate(lock, spread) {
	'use strict';
	var iv = [0,0,0,0,0,0];
    var message = {nd : generate1(lock, spread, iv, 0, 0)};
	postMessage(message);
}

function generate1(nm, ds, iv, mc, n) {
	'use strict';
	var nd = [0,0];
	for (var stat = 0; stat <= MAX; stat++) {
		iv[n] = stat;
		if (iv[n] == MAX)
        {
			mc++;
        }
		if (mc + 5 - n >= nm)
        {
			if (n < 5)
            {
				var cp = generate1(nm, ds, iv, mc, n + 1);
				nd[0] += cp[0];
				nd[1] += cp[1];
			} else
            {
				var p = true;
				for (var s = 0; p && s < 6; s++)
                {
					if ((ds[s] <= MAX && ds[s] != iv[s]) || (ds[s] == EVEN && iv[s] % 2 !== 0)|| (ds[s] == ODD && iv[s] % 2 !== 1))
                    {
						p = false;
                    }
				}
				if (p)
                {
					nd[0]++;
                }
				nd[1]++;
			}
		}
	}
	return nd;
}
</script>
<script>
const MAX = 31;
const EVEN = 32;
const ODD = 33;
const ANY = 34;

function calcIvs() {
    'use strict';
    document.getElementById('output').innerHTML = '';
    document.getElementById('calcButton').innerHTML = 'Calculating';
    document.getElementById('calcButton').disabled = true;
    var spread = [ 0, 0, 0, 0, 0, 0 ];
    var inputs = document.getElementsByTagName('input');
    for(var i = 0; i < 6; i++)
    {
        spread[i] = parseInt(inputs[i].value,10);
        if(isNaN(spread[i]))
        {
            if(spread[i] == 'x' || spread[i] == 'X')
            {
                spread[i] = ANY;
            } else if(spread[i] == 'e' || spread[i] == 'E')
            {
                spread[i] = EVEN;
            } else if(spread[i] == 'o' || spread[i] == 'O')
            {
                spread[i] = ODD;
            } else
            {
                spread[i] = ANY;
                inputs[i].value = 'x';
            }
        } else if (spread[i] < 0)
        {
            spread[i] = 0;
            inputs[i].value = 0;
        } else if (spread[i] > MAX)
        {
            spread[i] = MAX;
            inputs[i].value = MAX;
        }
    }
    var lock = parseInt(inputs[6].value,10);
    if(isNaN(lock))
    {
        lock = 0;
        inputs[6].value = '0';
    } else if(lock < 0)
    {
        lock = 0;
        inputs[6].value = '0';
    } else if(lock > 6)
    {
        lock = 6;
        inputs[6].value = '6';
    }

    var blob = new Blob([
          document.querySelector('#worker').textContent
        ], { type: "text/javascript" })
    
    if(typeof(Worker) !== 'undefined')
    {
        var worker = new Worker(window.URL.createObjectURL(blob));
        worker.onmessage = function (message) {
            var nd = message.data.nd;
            var p = Math.round(1000000.0 * nd[0] / nd[1])/10000;
            document.getElementById("output").innerHTML = "Chance: " + nd[0] + "/" + nd[1] + ", approx. " + p +"%";
            document.getElementById('calcButton').innerHTML = 'Calculate';
            document.getElementById('calcButton').disabled = false;
            worker.terminate();
        };
        var message = {lock : lock, spread: spread};
        worker.postMessage(message);
    } else
    {
        
    }
}
</script>

</body>
</html>